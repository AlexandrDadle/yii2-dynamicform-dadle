(function($){var pluginName="yiiDynamicForm",regexID=/^(.+?)([-\d-]{1,})(.+)$/i,regexName=/(^.+?)([\[\d{1,}\]]{1,})(\[.+\]$)/i;$.fn.yiiDynamicForm=function(e){return methods[e]?methods[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?($.error("Method "+e+" does not exist on jQuery.yiiDynamicForm"),!1):methods.init.apply(this,arguments)};var events={beforeInsert:"beforeInsert",afterInsert:"afterInsert",beforeDelete:"beforeDelete",afterDelete:"afterDelete",limitReached:"limitReached"},_resolveWidgetOptions=function(e){if(!e)return console.error("data-dynamicform attribute is missing."),null;var t=$.trim(e);if(!t.length)return console.error("data-dynamicform attribute is empty."),null;if("{"===t.charAt(0)||"["===t.charAt(0))try{return JSON.parse(t)}catch(e){return console.error("Failed to parse widget options JSON:",e),null}var i=window[t];return i||(console.error("Dynamic form options not found for key:",t),null)},methods={init:function(e){return this.each(function(){e.template=_parseTemplate(e)})},addItem:function(e,t,i){_addItem(e,t,i)},deleteItem:function(e,t,i){_deleteItem(e,t,i)},updateContainer:function(){var e=_resolveWidgetOptions($(this).attr("data-dynamicform"));e&&(_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e))}},_parseTemplate=function(e){var t=$(e.template);t.find("div[data-dynamicform]").each(function(){var e=_resolveWidgetOptions($(this).attr("data-dynamicform"));if(e&&$(e.widgetItem).length>1){var t=$(this).find(e.widgetItem).first()[0].outerHTML;$(this).find(e.widgetBody).html(t)}}),t.find("input, textarea, select").each(function(){if($(this).is(":checkbox")||$(this).is(":radio")){var e=$(this).is(":checkbox")?"checkbox":"radio",i=$(this).attr("name"),a=t.find('input[type="hidden"][name="'+i+'"]').first(),r=t.find('input[type="'+e+'"][name="'+i+'"]').length;a&&1===r&&($(this).val(1),a.val(0)),$(this).prop("checked",!1)}else $(this).is("select")?$(this).find("option:selected").removeAttr("selected"):$(this).val("")});var i=$("#"+e.formId).yiiActiveForm("data");return i&&i.settings&&(t.find("."+i.settings.errorCssClass).removeClass(i.settings.errorCssClass),t.find("."+i.settings.successCssClass).removeClass(i.settings.successCssClass)),t},_getWidgetOptionsRoot=function(e){return _resolveWidgetOptions($(e.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform"))},_getLevel=function(e){var t=e.parents("div[data-dynamicform]").length;return t=t<0?0:t},_count=function(e,t){return e.closest("."+t.widgetContainer).find(t.widgetItem).length},_createIdentifiers=function(e){return new Array(e+2).join("0").split("")},_addItem=function(e,t,i){_count(i,e)<e.limit?($toclone=$(e.template),$newclone=$toclone.clone(!1,!1),"top"===e.insertPosition?i.closest("."+e.widgetContainer).find(e.widgetBody).prepend($newclone):i.closest("."+e.widgetContainer).find(e.widgetBody).append($newclone),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),i.closest("."+e.widgetContainer).triggerHandler(events.afterInsert,$newclone)):i.closest("."+e.widgetContainer).triggerHandler(events.limitReached,e.limit)},_removeValidations=function(e,t,i){if(i>1){e.find("div[data-dynamicform]").each(function(){var e=_resolveWidgetOptions($(this).attr("data-dynamicform"));if(e)for(var t=_getLevel($(this)),i=_createIdentifiers(t),a=$(this).find(e.widgetItem).length,r=1;r<=a-1;r++){var n=i;n[t]=r,e.fields.forEach(function(t){var i=t.id.replace("{}",n.join("-"));void 0!==$("#"+e.formId).yiiActiveForm("find",i)&&$("#"+e.formId).yiiActiveForm("remove",i)})}});var a=_getLevel(e.closest("."+t.widgetContainer)),r=_getWidgetOptionsRoot(t);if(!r)return;var n=_createIdentifiers(a);n[0]=$(r.widgetItem).length-1,n[a]=i-1,t.fields.forEach(function(e){var i=e.id.replace("{}",n.join("-"));void 0!==$("#"+t.formId).yiiActiveForm("find",i)&&$("#"+t.formId).yiiActiveForm("remove",i)})}},_deleteItem=function(e,t,i){var a=_count(i,e);a>e.min&&($todelete=i.closest(e.widgetItem),!1!==$("."+e.widgetContainer).triggerHandler(events.beforeDelete,$todelete)&&(_removeValidations($todelete,e,a),$todelete.remove(),_updateAttributes(e),_restoreSpecialJs(e),_fixFormValidaton(e),$("."+e.widgetContainer).triggerHandler(events.afterDelete)))},_updateAttrID=function(e,t){var i=_resolveWidgetOptions(e.closest("div[data-dynamicform]").attr("data-dynamicform"));if(i){var a=e.attr("id"),r=a;if(void 0!==a){var n=a.match(regexID);if(n&&4===n.length){n[2]=n[2].substring(1,n[2].length-1);var o=n[2].split("-");if(o[0]=t,o.length>1){var d=[],s=!1;if(e.parents("div[data-dynamicform]").each(function(e){var t=_resolveWidgetOptions($(this).attr("data-dynamicform"));if(!t)return s=!0,!1;d[e]=t}),s)return;d=d.reverse();for(var c=o.length-1;c>=1;c--)o[c]=e.closest(d[c].widgetItem).index()}r=n[1]+"-"+o.join("-")+"-"+n[3],e.attr("id",r)}else r=a+t,e.attr("id",r)}return a!==r&&(e.closest(i.widgetItem).find(".field-"+a).each(function(){$(this).removeClass("field-"+a).addClass("field-"+r)}),e.closest(i.widgetItem).find("label[for='"+a+"']").attr("for",r)),r}},_updateAttrName=function(e,t){var i=e.attr("name");if(void 0!==i){var a=i.match(regexName);if(a&&4===a.length){a[2]=a[2].replace(/\]\[/g,"-").replace(/\]|\[/g,"");var r=a[2].split("-");if(r[0]=t,r.length>1){var n=[],o=!1;if(e.parents("div[data-dynamicform]").each(function(e){var t=_resolveWidgetOptions($(this).attr("data-dynamicform"));if(!t)return o=!0,!1;n[e]=t}),o)return;n=n.reverse();for(var d=r.length-1;d>=1;d--)r[d]=e.closest(n[d].widgetItem).index()}i=a[1]+"["+r.join("][")+"]"+a[3],e.attr("name",i)}}return i},_updateAttributes=function(e){var t=_getWidgetOptionsRoot(e);t&&$(t.widgetItem).each(function(e){$(this);$(this).find("*").each(function(){_updateAttrID($(this),e),_updateAttrName($(this),e)})})},_fixFormValidatonInput=function(e,t,i,a){void 0!==t&&((t=$.extend(!0,{},t)).id=i,t.container=".field-"+i,t.input="#"+i,t.name=a,t.value=$("#"+i).val(),t.status=0,void 0!==$("#"+e.formId).yiiActiveForm("find",i)&&$("#"+e.formId).yiiActiveForm("remove",i),$("#"+e.formId).yiiActiveForm("add",t))},_fixFormValidaton=function(e){var t=_getWidgetOptionsRoot(e);t&&$(t.widgetBody).find("input, textarea, select").each(function(){var e=$(this).attr("id"),t=$(this).attr("name");if(void 0!==e&&void 0!==t){var i=_resolveWidgetOptions($(this).closest("div[data-dynamicform]").attr("data-dynamicform"));if(!i)return;var a=e.match(regexID);if(a&&4===a.length){a[2]=a[2].substring(1,a[2].length-1);var r=_getLevel($(this)),n=_createIdentifiers(r-1),o=a[1]+"-"+n.join("-")+"-"+a[3],d=$("#"+i.formId).yiiActiveForm("find",o);void 0!==d&&_fixFormValidatonInput(i,d,e,t)}}})},_restoreKrajeeDepdrop=function($elem){var configDepdrop=$.extend(!0,{},eval($elem.attr("data-krajee-depdrop"))),inputID=$elem.attr("id"),matchID=inputID.match(regexID);if(matchID&&4===matchID.length)for(index=0;index<configDepdrop.depends.length;++index){var match=configDepdrop.depends[index].match(regexID);match&&4===match.length&&(configDepdrop.depends[index]=match[1]+matchID[2]+match[3])}$elem.depdrop(configDepdrop)},_restoreSpecialJs=function(widgetOptions){var widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions);if(widgetOptionsRoot){var $hasInputmask=$(widgetOptionsRoot.widgetItem).find("[data-plugin-inputmask]");$hasInputmask.length>0&&$hasInputmask.each(function(){$(this).inputmask("remove"),$(this).inputmask(eval($(this).attr("data-plugin-inputmask")))});var $hasDatepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-datepicker], [data-krajee-kvDatepicker]");$hasDatepicker.length>0&&$hasDatepicker.each(function(){var $input=$(this),pluginAttr=$input.attr("data-krajee-kvDatepicker")?"data-krajee-kvDatepicker":"data-krajee-datepicker",pluginName="data-krajee-kvDatepicker"===pluginAttr?"kvDatepicker":"datepicker",pluginConfigVar=$input.attr(pluginAttr);if(pluginConfigVar&&"function"==typeof $.fn[pluginName]){var pluginConfig=eval(pluginConfigVar),sourceId=$input.attr("data-datepicker-source"),$target=sourceId?$(document.getElementById(sourceId)):$input;$target&&$target.length||($target=$input),$target.data("datepicker")&&("function"==typeof $target.kvDatepicker&&$target.kvDatepicker("remove"),"function"==typeof $target.datepicker&&$target.datepicker("remove")),$target.removeData(),"kvDatepicker"===pluginName?$target.kvDatepicker(pluginConfig):$target.datepicker(pluginConfig)}});var $hasDateTimepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-datetimepicker]");$hasDateTimepicker.length>0&&"function"==typeof $.fn.datetimepicker&&$hasDateTimepicker.each(function(){var $input=$(this),pluginConfigVar=$input.attr("data-krajee-datetimepicker");if(pluginConfigVar){var pluginConfig=eval(pluginConfigVar),sourceId=$input.attr("data-datetimepicker-source")||$input.attr("data-datepicker-source"),$target=sourceId?$(document.getElementById(sourceId)):$input;$target&&$target.length||($target=$input),$target.data("datetimepicker")&&$target.datetimepicker("remove"),$target.removeData(),$target.datetimepicker(pluginConfig)}});var $hasTimepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-timepicker]");$hasTimepicker.length>0&&$hasTimepicker.each(function(){$(this).removeData().off(),$(this).parent().find(".bootstrap-timepicker-widget").remove(),$(this).unbind(),$(this).timepicker(eval($(this).attr("data-krajee-timepicker")))});var $hasMaskmoney=$(widgetOptionsRoot.widgetItem).find("[data-krajee-maskMoney]");$hasMaskmoney.length>0&&$hasMaskmoney.each(function(){$(this).parent().find("input").removeData().off();var id="#"+$(this).attr("id"),displayID=id+"-disp";$(displayID).maskMoney("destroy"),$(displayID).maskMoney(eval($(this).attr("data-krajee-maskMoney"))),$(displayID).maskMoney("mask",parseFloat($(id).val())),$(displayID).on("change",function(){var e=$(displayID).maskMoney("unmasked")[0];$(id).val(e),$(id).trigger("change")})});var $hasFileinput=$(widgetOptionsRoot.widgetItem).find("[data-krajee-fileinput]");$hasFileinput.length>0&&$hasFileinput.each(function(){$(this).fileinput(eval($(this).attr("data-krajee-fileinput")))});var $hasTouchSpin=$(widgetOptionsRoot.widgetItem).find("[data-krajee-TouchSpin]");$hasTouchSpin.length>0&&$hasTouchSpin.each(function(){$(this).TouchSpin("destroy"),$(this).TouchSpin(eval($(this).attr("data-krajee-TouchSpin")))});var $hasSpectrum=$(widgetOptionsRoot.widgetItem).find("[data-krajee-spectrum]");$hasSpectrum.length>0&&$hasSpectrum.each(function(){var id="#"+$(this).attr("id"),sourceID=id+"-source";$(sourceID).spectrum("destroy"),$(sourceID).unbind(),$(id).unbind();var configSpectrum=eval($(this).attr("data-krajee-spectrum"));configSpectrum.change=function(e){jQuery(id).val(e.toString())},$(sourceID).attr("name",$(sourceID).attr("id")),$(sourceID).spectrum(configSpectrum),$(sourceID).spectrum("set",jQuery(id).val()),$(id).on("change",function(){$(sourceID).spectrum("set",jQuery(id).val())})});var $hasDepdrop=$(widgetOptionsRoot.widgetItem).find("[data-krajee-depdrop]");$hasDepdrop.length>0&&$hasDepdrop.each(function(){void 0===$(this).data("select2")&&($(this).removeData().off(),$(this).unbind(),_restoreKrajeeDepdrop($(this)))});var $hasSelect2=$(widgetOptionsRoot.widgetItem).find("[data-krajee-select2]");$hasSelect2.length>0&&$hasSelect2.each(function(){var id=$(this).attr("id"),configSelect2=eval($(this).attr("data-krajee-select2"));$(this).data("select2")&&$(this).select2("destroy");var configDepdrop=$(this).data("depdrop");configDepdrop&&(configDepdrop=$.extend(!0,{},configDepdrop),$(this).removeData().off(),$(this).unbind(),_restoreKrajeeDepdrop($(this))),$.when($("#"+id).select2(configSelect2)).done(initSelect2Loading(id,".select2-container--krajee"));var kvClose="kv_close_"+id.replace(/\-/g,"_");if($("#"+id).on("select2:opening",function(e){initSelect2DropStyle(id,kvClose,e)}),$("#"+id).on("select2:unselect",function(){window[kvClose]=!0}),configDepdrop){var loadingText=configDepdrop.loadingText?configDepdrop.loadingText:"Loading ...";initDepdropS2(id,loadingText)}})}}})(window.jQuery);